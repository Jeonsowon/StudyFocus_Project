# StudyFocus_Project

## Project Overview ğŸ–¥ï¸

### ê°œë°œ í™˜ê²½

> window10, python3.10

### ê°œë°œ ëª©ì 

> í•™ìŠµ í™˜ê²½ì´ ì˜¤í”„ë¼ì¸ì—ì„œ ì˜¨ë¼ì¸ìœ¼ë¡œ ë³€í™”ë˜ê³  ìˆìŠµë‹ˆë‹¤. ì§‘ì—ì„œ í˜¼ì ì˜¨ë¼ì¸ìœ¼ë¡œ ê°•ì˜ë¥¼ ë³´ëŠ” ê²ƒì€ ê°•ì˜ì‹¤ì—ì„œ ì‹¤ì‹œê°„ìœ¼ë¡œ ìˆ˜ì—…ì„ ë“£ëŠ” ê²ƒë³´ë‹¤ ì§‘ì¤‘ë„ê°€ ë–¨ì–´ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ê·¸ë˜ì„œ ì˜¨ë¼ì¸ìœ¼ë¡œ í•™ìŠµ ì¤‘ì¸ ì‚¬ìš©ìì˜ ì§‘ì¤‘ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ ë¶„ì„í•˜ê³  í”¼ë“œë°± ì¤„ ìˆ˜ ìˆëŠ” ë„êµ¬ë¥¼ ìƒê°í–ˆìŠµë‹ˆë‹¤.

> ì‚¬ìš©ìì˜ ëˆˆ ê°ê¹€ì´ë‚˜ ê³ ê°œ ì´íƒˆ ë“± ì£¼ì˜ê°€ ííŠ¸ëŸ¬ì§„ ìƒíƒœê°€ ì§€ì†ë¨ì„ ê²½ê³ í•˜ê³  ì§‘ì¤‘ ì ìˆ˜ë¥¼ í”¼ë“œë°±í•˜ì—¬ ìŠ¤ìŠ¤ë¡œ í•™ìŠµ ìƒíƒœë¥¼ ì ê²€í•  ìˆ˜ ìˆë„ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤. ë˜í•œ ì§‘ì¤‘ë ¥ì´ ë–¨ì–´ì§„ ìˆœê°„ì„ ê¸°ë¡í•˜ì—¬ ë³µìŠµì´ í•„ìš”í•œ ë¶€ë¶„ì„ í™•ì¸í•˜ì—¬ í•™ìŠµ íš¨ìœ¨ì„ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆëŠ” ë„êµ¬ë¡œ ê°œë°œí•˜ì˜€ìŠµë‹ˆë‹¤.

### ê¸°ìˆ  ìŠ¤íƒ

> - Python 3.10 ì´ìƒ
> - OpenCV: ì‹¤ì‹œê°„ ë¹„ë””ì˜¤ ì²˜ë¦¬
> - MediaPipe: ì–¼êµ´ ëœë“œë§ˆí¬ ì¶”ì 
> - Streamlit: ì›¹ ê¸°ë°˜ ì‹¤ì‹œê°„ UI êµ¬ì„±
> - SimpleAudio: ê²½ê³ ìŒ ì¬ìƒ
> - Pandas: ë¡œê·¸ í…Œì´ë¸”
> - NumPy: ìˆ˜ì¹˜ ê³„ì‚°

---

## âœ¨ Project Description âœ¨

- íŒŒì¼ ì„¤ëª…

  - main.py  
    : í”„ë¡œê·¸ë¨ì´ ì§„í–‰ë˜ëŠ” python source code.
  - alarm.wav  
    : ì£¼ì˜ ííŠ¸ëŸ¬ì§„ ìƒíƒœë¡œ ê°ì§€í•˜ë©´ ìš¸ë¦¬ëŠ” ê²½ê³ ìŒ
  - requirements.txt  
    : ì„¤ì¹˜ í•„ìš” ë¼ì´ë¸ŒëŸ¬ë¦¬ ëª…ì„¸ì„œ

- ë™ì‘ íë¦„

1. ì´ˆê¸° 60í”„ë ˆì„ ë™ì•ˆ ì½” ìœ„ì¹˜ ê¸°ì¤€ì  ì„¤ì •
2. ì´í›„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëˆˆ ê°ê¹€ ë° ê³ ê°œ ì´íƒˆ ì—¬ë¶€ ê°ì§€
3. ëˆˆ ê°ê¹€ ë˜ëŠ” ê³ ê°œ ì´íƒˆì´ 10ì´ˆ ì´ìƒ ì§€ì†ë˜ë©´:

- ê²½ê³ ìŒ ì¬ìƒ
- ë¡œê·¸ ê¸°ë¡

4. 1ë¶„ ë‹¨ìœ„ë¡œ ì§‘ì¤‘ ìƒíƒœ ìœ ì§€ ì‹œ ì ìˆ˜ ì¦ê°€
5. ì‹¤ì‹œê°„ UIë¥¼ í†µí•´ ìƒíƒœ ë° ê·¸ë˜í”„ ì œê³µ

- UI êµ¬ì„±
  - ì¢Œì¸¡: ì‹¤ì‹œê°„ ì›¹ìº  ì˜ìƒ
  - ìš°ì¸¡: ìƒíƒœ í…ìŠ¤íŠ¸, ì§‘ì¤‘ ì ìˆ˜, ì‹¤ì‹œê°„ ê·¸ë˜í”„, ê²½ê³  ë¡œê·¸ í…Œì´ë¸”
- <main.py> ì½”ë“œ ì„¤ëª…

  ```python
  import streamlit as st
  import cv2
  import mediapipe as mp
  import numpy as np
  import time
  import pandas as pd
  import simpleaudio as sa
  ```

  > pip install and import library í•„ìš”

  ```
  # ìƒíƒœ ì €ì¥
  if "score_log" not in st.session_state:
      st.session_state.score_log = []
  if "warning_log" not in st.session_state:
      st.session_state.warning_log = []
  if "start_time" not in st.session_state:
      st.session_state.start_time = time.time()
  if "frame_count" not in st.session_state:
      st.session_state.frame_count = 0
  if "calibration_sum" not in st.session_state:
      st.session_state.calibration_sum = [0, 0]
  if "calibrated_center" not in st.session_state:
      st.session_state.calibrated_center = None
  if "last_score_update" not in st.session_state:
      st.session_state.last_score_update = time.time()
  ```

  > Streamlitì€ ì„¸ì…˜ë§ˆë‹¤ ìƒíƒœê°€ ì´ˆê¸°í™”ë˜ë¯€ë¡œ st.session_stateë¥¼ í†µí•´ ì§€ì†ì ìœ¼ë¡œ ì •ë³´ë¥¼ ì €ì¥
  > score_log, warning_log, start_time ë“±ì€ ì ìˆ˜ ëˆ„ì , ê²½ê³  ê¸°ë¡, íƒ€ì´ë¨¸ ë“±ì„ ìœ„í•´ í•„ìš”

  ```
  # Mediapipe ì´ˆê¸°í™”
  mp_face_mesh = mp.solutions.face_mesh
  face_mesh = mp_face_mesh.FaceMesh(refine_landmarks=True)
  LEFT_EYE = [33, 160, 158, 133, 153, 144]
  RIGHT_EYE = [263, 387, 385, 362, 380, 373]
  ```

  > FaceMeshë¥¼ í†µí•´ ì–¼êµ´ì˜ 3D ëœë“œë§ˆí¬ë¥¼ ê°ì§€ (ëˆˆ, ì½”, í„± ë“±)
  > refine_landmarks=TrueëŠ” ëˆˆê³¼ ì… ë“±ì˜ ì •ë°€í•œ ìœ„ì¹˜ê¹Œì§€ ì¶”ì  ê°€ëŠ¥
  > EAR ê³„ì‚°ì„ ìœ„í•´ í•„ìš”í•œ ëˆˆ ì¢Œí‘œ ì¸ë±ìŠ¤

  ```
  CALIBRATION_FRAMES = 60
  EAR_THRESHOLD = 0.2
  WARNING_DURATION = 10
  HEAD_MOVE_THRESHOLD_X = 60
  HEAD_MOVE_THRESHOLD_Y = 40
  ```

  > ê³ ê°œ ì´íƒˆì˜ ê¸°ì¤€ì  ì„¤ì •ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì½” ìœ„ì¹˜ë¥¼ 60í”„ë ˆì„ë™ì•ˆ í‰ê·  ë‚´ì–´ ì¤‘ì‹¬ ì¢Œí‘œë¥¼ ì„¤ì •
  > ëˆˆ ê°ê¹€ê³¼ ê³ ê°œ ì´íƒˆ ì¸ì‹ ê¸°ì¤€ ì„¤ì •
  > ë¹„ì§‘ì¤‘ ìƒíƒœ 10ì´ˆ ì§€ì†ë˜ë©´ ê²½ê³ ìŒ ê¸°ì¤€ ì„¤ì •

  ```
  head_off_start = None
  eyes_closed_start = None
  head_moved_warned = False
  eyes_closed_warned = False
  head_moved_status_start = None
  eyes_closed_status_start = None

  st.title("ğŸ“ ì§‘ì¤‘ë„ ì¸¡ì •ê¸°")
  left_col, right_col = st.columns([1, 1])

  FRAME_WINDOW = left_col.image([])
  st_focused = right_col.empty()
  st_timer = right_col.empty()
  st_chart = right_col.empty()
  st_log = right_col.empty()

  stop = st.sidebar.button("ğŸ›‘ ì„¸ì…˜ ì¢…ë£Œ", key="stop_button")

  cap = cv2.VideoCapture(0)
  focus_score = 0
  status_text = "Detecting..."
  ```

  > ë³€ìˆ˜ ì´ˆê¸° ì„¤ì • ë° ì›¹ìº  ì—´ê¸°
  > Streamlit UI êµ¬ì„±ìœ¼ë¡œ ì¢Œì¸¡ì— ì‹¤ì‹œê°„ ì›¹ìº  í‘œì‹œ, ìš°ì¸¡ ìƒíƒœ í…ìŠ¤íŠ¸, ì ìˆ˜, ê·¸ë˜í”„, ê²½ê³  ë¡œê·¸ í‘œì‹œ

  ```
  def calculate_ear(landmarks, eye_indices, w, h):
    p = [np.array([landmarks[i].x * w, landmarks[i].y * h]) for i in eye_indices]
    ear = (np.linalg.norm(p[1] - p[5]) + np.linalg.norm(p[2] - p[4])) / (2.0 * np.linalg.norm(p[0] - p[3]))
    return ear
  ```

  > EAR (Eye Aspect Ratio): ëˆˆì˜ ì„¸ë¡œ ê¸¸ì´ ëŒ€ë¹„ ê°€ë¡œ ê¸¸ì´ë¥¼ ë¹„ìœ¨ë¡œ ë‚˜íƒ€ë‚¸ ê°’ì„ ê³„ì‚°í•˜ëŠ” í•¨ìˆ˜
  > ëˆˆì˜ landmark ì¢Œí‘œë¡œ EAR ê³„ì‚°, ê°’ì´ ë‚®ì„ìˆ˜ë¡ ëˆˆ ê°ìŒìœ¼ë¡œ ì¸ì‹

  ```
  def play_alert():
  try:
      wave_obj = sa.WaveObject.from_wave_file("alarm.wav")
      wave_obj.play()
  except:
      pass
  ```

  > ì‚¬ìš©ìì—ê²Œ ê²½ê³ ìŒì„ í†µí•´ ìŠ¤ìŠ¤ë¡œ ì§‘ì¤‘ ìƒíƒœë¥¼ ì ê²€í•˜ë„ë¡ ì‹œê°ì ì¸ í”¼ë“œë°± ì™¸ì—ë„ ì²­ê°ì ì¸ ì•Œë¦¼ ì„¤ì • í•¨ìˆ˜

  ```
  while cap.isOpened() and not stop:
  ```

  > ì›¹ìº¡ì—ì„œ ì‹¤ì‹œê°„ í”„ë ˆì„ ë°›ì•„ ë¶„ì„í•˜ëŠ” ë©”ì¸ ë£¨í”„ ì‹œì‘

  ```
  if st.session_state.calibrated_center is None and st.session_state.frame_count < CALIBRATION_FRAMES:
    st.session_state.calibration_sum[0] += nx
    st.session_state.calibration_sum[1] += ny
    st.session_state.frame_count += 1
    current_status = f"ê¸°ì¤€ì  ì„¤ì • ì¤‘ ({st.session_state.frame_count}/{CALIBRATION_FRAMES})"
    if st.session_state.frame_count == CALIBRATION_FRAMES:
        cx = st.session_state.calibration_sum[0] / CALIBRATION_FRAMES
        cy = st.session_state.calibration_sum[1] / CALIBRATION_FRAMES
        st.session_state.calibrated_center = (cx, cy)
    continue
  ```

  > ì´ˆê¸° 60í”„ë ˆì„ ë™ì•ˆ ì½”ì˜ ìœ„ì¹˜ í‰ê· ì„ ê³„ì‚°í•˜ì—¬ ê¸°ì¤€ì ìœ¼ë¡œ ì„¤ì •

  ```
  if st.session_state.calibrated_center:
    cx, cy = st.session_state.calibrated_center
    dx = abs(cx - nx)
    dy = abs(cy - ny)
    if dx > HEAD_MOVE_THRESHOLD_X or dy > HEAD_MOVE_THRESHOLD_Y:
      if not head_off_start:
          head_off_start = now
      if not head_moved_status_start:
          head_moved_status_start = now
      head_moved = True
      if now - head_off_start >= WARNING_DURATION and not head_moved_warned:
          play_alert()
          hms = time.strftime('%H:%M:%S', time.gmtime(elapsed_time))
          st.session_state.warning_log.append((hms, "ê³ ê°œ ì´íƒˆ ê²½ê³ "))
          head_moved_warned = True
    else:
        head_off_start = None
        head_moved_warned = False
        head_moved_status_start = None
  ```

  > í˜„ì¬ ì½” ìœ„ì¹˜ì™€ ê¸°ì¤€ì  ì°¨ì´(dx, dy)ê°€ ì„ê³„ê°’ ì´ìƒì´ë©´ ê³ ê°œ ì´íƒˆë¡œ íŒë‹¨ 10ì´ˆ ì´ìƒ ì§€ì†ë˜ë©´ ê³ ê°œ ì´íƒˆ ê²½ê³ ìŒ ë°œìƒ

  ```
  left_ear = calculate_ear(landmarks, LEFT_EYE, w, h)
  right_ear = calculate_ear(landmarks, RIGHT_EYE, w, h)
  avg_ear = (left_ear + right_ear) / 2.0
  if avg_ear < EAR_THRESHOLD:
      if not eyes_closed_start:
          eyes_closed_start = now
      if not eyes_closed_status_start:
          eyes_closed_status_start = now
      eyes_closed = True
      if now - eyes_closed_start >= WARNING_DURATION and not eyes_closed_warned:
          play_alert()
          hms = time.strftime('%H:%M:%S', time.gmtime(elapsed_time))
          st.session_state.warning_log.append((hms, "ëˆˆ ê°ê¹€ ê²½ê³ "))
          eyes_closed_warned = True
  else:
      eyes_closed_start = None
      eyes_closed_warned = False
      eyes_closed_status_start = None
  ```

  > EAR < 0.2 ì´ê³  10ì´ˆ ì´ìƒ ì§€ì†ë˜ë©´ ëˆˆ ê°ê¹€ ê°ì§€ ë° ê²½ê³ ìŒ ë°œìƒ


  ```
  if eyes_closed_status_start and now - eyes_closed_status_start >= STATUS_DURATION:
      current_status = "ğŸ˜´ Eyes Closed"
  elif head_moved_status_start and now - head_moved_status_start >= STATUS_DURATION:
      current_status = "ğŸ§  Head Moved"
  elif st.session_state.frame_count >= CALIBRATION_FRAMES:
      current_status = "âœ… Focused"

  st_focused.markdown(f"### ìƒíƒœ: **{current_status}**")
  st.session_state.status_log.append((now, current_status))
  ```

  > í˜„ì¬ ìƒíƒœë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í…ìŠ¤íŠ¸ë¡œ ë°˜ì˜í•˜ì—¬ ì‚¬ìš©ìì—ê²Œ ì‹œê° í”¼ë“œë°± ì œê³µ

  ```
  if now - st.session_state.last_score_update >= 60:
      window_start = st.session_state.last_score_update
      window_end = now

      def parse_hms_to_elapsed_seconds(hms_str):
          h, m, s = map(int, hms_str.split(":"))
          return h * 3600 + m * 60 + s

      warning_in_window = any(
          window_start <= st.session_state.start_time + parse_hms_to_elapsed_seconds(log[0]) <= window_end
          for log in st.session_state.warning_log
      )

      if not warning_in_window:
          focus_score += 1

      minutes_passed = int((now - st.session_state.start_time) // 60)
      st.session_state.score_log.append(focus_score)
      st.session_state.score_timestamps.append(f"{minutes_passed}ë¶„")
      st.session_state.last_score_update = now
  ```

  > ë§¤ 1ë¶„ë§ˆë‹¤ ì´ì „ 1ë¶„ ë™ì•ˆì˜ ìƒíƒœ ë¡œê·¸ë¥¼ ë¶„ì„í•˜ì—¬ ì§‘ì¤‘ ì ìˆ˜ ì¦ê°€ ì—¬ë¶€ ê²°ì •
  > ë§Œì•½ ê²½ê³ ê°€ í•˜ë‚˜ë„ ì—†ìœ¼ë©´ ì ìˆ˜ 1ì  ì¦ê°€

  ```
  FRAME_WINDOW.image(img, channels="BGR")
  st_timer.metric("ëˆ„ì  ì§‘ì¤‘ ì ìˆ˜", f"{focus_score}")
  if st.session_state.score_log:
      score_df = pd.DataFrame({"ì‹œê°„ (ë¶„)": st.session_state.score_timestamps, "ì ìˆ˜": st.session_state.score_log})
      st_chart.line_chart(score_df.set_index("ì‹œê°„ (ë¶„)"))
  if st.session_state.warning_log:
      st_log.table(pd.DataFrame(st.session_state.warning_log, columns=["ê²½ê³¼ ì‹œê°„", "ê²½ê³  ë‚´ìš©"]))
  ```

  > ì ìˆ˜ëŠ” ìˆ«ì ë° ë¼ì¸ ì°¨íŠ¸ë¡œ ì‹œê°í™”, ê²½ê³ ëŠ” í‘œ í˜•íƒœë¡œ í‘œì‹œ

  ```
  cap.release()
  
  st.success("ì„¸ì…˜ ì¢…ë£Œ! ì§‘ì¤‘ ì ìˆ˜ ê·¸ë˜í”„ ë° ë¡œê·¸ë¥¼ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
  
  center_col = st.columns([1, 2, 1])[1]
  
  with center_col:
      st.subheader("ğŸ“ˆ ì§‘ì¤‘ ì ìˆ˜ ì¶”ì´")
      if st.session_state.score_log:
          score_df = pd.DataFrame({"ì‹œê°„ (ë¶„)": st.session_state.score_timestamps, "ì ìˆ˜": st.session_state.score_log})
          st.line_chart(score_df.set_index("ì‹œê°„ (ë¶„)"))
  
      if st.session_state.warning_log:
          st.subheader("âš ï¸ ê²½ê³  ë¡œê·¸")
          st.table(pd.DataFrame(st.session_state.warning_log, columns=["ê²½ê³¼ ì‹œê°„", "ê²½ê³  ë‚´ìš©"]))
  ```

  >  ì„¸ì…˜ ì¢…ë£Œ í›„ ì§‘ì¤‘ ì ìˆ˜ ê·¸ë˜í”„ì™€ ê²½ê³  ë¡œê·¸ ê²°ê³¼ ë‹¤ì‹œ ì¶œë ¥í•˜ì—¬ ë³µìŠµ í•„ìš” ë¶€ë¶„ í™•ì¸



### Developer ğŸ™‹
  21102318 ì „ì†Œì›
